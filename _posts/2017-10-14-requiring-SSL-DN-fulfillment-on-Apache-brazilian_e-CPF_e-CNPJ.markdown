---
layout:   post
comments: true
seo:      true
title:    "Requiring SSL DN fulfillment on Apache - brazilian e-CPF/e-CNPJ"
date:     2017-10-14 22:30:00 -0300
tags:     certificate authority CA icp-brasil iti RFB e-CPF e-CNPJ eCPF eCNPJ Safenet token A3 RequireSSL DN clientauth receita
---

## Introduction
To authenticate a client, you have to require him to present a valid certificate. To assure that the certificate is valid, you have to check if it was generated by Certification Authorities you trust. This can be accomplished on Apache web server in that way:

```
SSLCACertificateFile /etc/pki/tls/certs/keystore_ICP_Brasil.pem
SSLVerifyClient require
SSLVerifyDepth 10
```

But if you want to restrict more and accept only valid certificates with some specific requirements?

## SSLRequire
In Apache, you have the powerful ```SSLRequire``` directive to accomplish this. As an example, follow a configuration to require a specific type of certificate, the certificates from brazilian persons (natural or legal):

```
SSLRequire ( \
%{SSL_CLIENT_S_DN_O} eq "ICP-Brasil" and \
%{SSL_CLIENT_S_DN_C} eq "BR" and \
%{SSL_CLIENT_S_DN_OU} eq "Secretaria da Receita Federal do Brasil - RFB" ) and ( \
%{SSL_CLIENT_S_DN_CN} =~ m/^.*\:[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]$/ or \
%{SSL_CLIENT_S_DN_CN} =~ m/^.*\:[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]$/ )
```

This example is telling Apache that the client will be successfully authenticated only if:

 1. ```SSL_CLIENT_S_DN_O``` is equal to the string "ICP-Brasil";
 2. ```SSL_CLIENT_S_DN_C``` is equal to the string "BR";
 3. ```SSL_CLIENT_S_DN_OU``` is equal to the string "Secretaria da Receita Federal do Brasil - RFB";
 4. ```SSL_CLIENT_S_DN_CN``` matches on of two regular expressions - it must end, after any characters, with a colon followed by eleven or fourteen numbers. Eleven numbers for natural persons and fourteen for legal persons.

## e-CPF/e-CNPJ Distinguished Name Composition
The above example refers to the Distinguished Name layout specification of e-CPF and e-CNPJ brazilian persons certificates. The official document with detailed information about e-CPF and e-CNPJ layouts is the ["Leiaute dos Certificados Digitais da Secretaria da Receita Federal do Brasil"](http://idg.receita.fazenda.gov.br/orientacao/tributaria/senhas-e-procuracoes/senhas/certificados-digitais/leiautedecertificadosdasrf.pdf). Below you can see two excerpts taken from this document, in it's 4.2 version:

e-CPF Distinguished Name (DN) Composition:
```
CN=<Nome da Pessoa Física> <:> <número de inscrição no CPF>
OU=<Identificação da AR >
OU=<Domínio do certificado>
OU=<RFB e-CPF ** >
OU=Secretaria da Receita Federal do Brasil – RFB
O=ICP-Brasil
C=BR
```

e-CNPJ Distinguished Name (DN) Composition:
```
CN=<Nome Empresarial> <:> <número de inscrição no CNPJ>
OU=<Identificação da AR >
OU=<RFB e-CNPJ ** >
OU=Secretaria da Receita Federal do Brasil – RFB
L=<cidade>
ST=<sigla da unidade da federação >
O=ICP-Brasil
C=BR
```

{% if page.comments %}
<div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = https://nmoura.github.io/2017/08/28/the-beginning-my-first-computer.html;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = /2017/08/28/the-beginning-my-first-computer.html; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://nilton-mouras-personal-page.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<script id="dsq-count-scr" src="//nilton-mouras-personal-page.disqus.com/count.js" async></script>

{% endif %}

{% if page.seo %}
    {% seo %}
{% endif %}
